# Story 4.3: Expense by Category Pie Chart

## Story Overview
**Epic:** Epic 4: Dashboard & Visualization  
**Story ID:** 4.3  
**Priority:** High  
**Estimated Effort:** 1-2 developer days  
**Status:** approved

## User Story
**As a** user  
**I want to** see a pie chart of my expenses broken down by category for the current month  
**So that** I can understand where my money is going and make informed financial decisions

## Acceptance Criteria

### AC1: Pie Chart Visualization Display
**Given** I have expense transactions in the current calendar month  
**When** I view the dashboard  
**Then** the dashboard includes a pie chart visualization showing expense categories  
**And** the chart aggregates all expenses from the current calendar month grouped by category  
**And** the chart has a professional, modern appearance using ready-made components

### AC2: Interactive Chart Features
**Given** the expense pie chart is displayed  
**When** I hover over a chart slice  
**Then** a tooltip shows the category name and total amount spent  
**And** the slice is highlighted with a hover effect  
**And** the interaction feels smooth and responsive

### AC3: Chart Data and Formatting
**Given** I have expenses across multiple categories  
**When** the pie chart is rendered  
**Then** each category is represented by a distinct color  
**And** amounts are formatted with proper currency display  
**And** categories with zero expenses are excluded from the chart  
**And** the chart shows percentage breakdowns for each category

## Dev Notes

### Previous Story Insights
- **Epic 4 Foundation**: Stories 4.1 and 4.2 established dashboard infrastructure with working data flow [Source: 4.1.display-account-balances.story.md, 4.2.display-recent-transactions-feed.story.md]
- **Dashboard Service**: Existing `/api/dashboard/stats` endpoint provides transaction data that can be extended [Source: 4.2.display-recent-transactions-feed.story.md#Task 2]
- **Modern UI Patterns**: Established shadcn/ui component integration and modern styling patterns [Source: 4.2.display-recent-transactions-feed.story.md#Dev Agent Record]
- **Ready-made Components**: User specifically requested using Recharts and shadcn modern components instead of building from scratch

### Data Models
**Transaction Schema** [Source: architecture/3-database-schema.md#transactions]:
```typescript
interface Transaction {
  id: string (UUID, PK)
  userId: string (FK → users.id)
  accountId: string (FK → accounts.id)
  amount: number
  type: 'income' | 'expense'
  category: string
  description: string
  date: string (ISO format)
  createdAt: string
}
```

**Category Aggregation Format**:
```typescript
interface CategoryExpense {
  category: string
  amount: number
  percentage: number
  color: string
  transactionCount: number
}
```

### Modern Component Stack Requirements
**Recharts Integration** [User Requirement]:
- **Recharts 2.x** - Industry-standard React charting library
- **PieChart, Cell, Tooltip, ResponsiveContainer** - Ready-made pie chart components
- **Modern, accessible charts** with smooth animations and interactions

**shadcn/ui Components** [User Requirement]:
- **Card, CardContent, CardHeader, CardTitle** - Professional card layouts for chart container
- **Consistent design system** following established shadcn patterns from Story 4.2
- **No custom chart building** - leverage existing, tested components

### API Specifications
**Enhanced Dashboard API Endpoint**:
- Extend existing `GET /api/dashboard/stats` to include category breakdown:
  ```typescript
  interface DashboardStats {
    totalBalance: number
    accountBalances: AccountBalance[]
    recentTransactions: RecentTransaction[]
    expensesByCategory: CategoryExpense[]  // NEW
  }
  ```

**Data Processing Requirements**:
- Filter transactions for current calendar month
- Exclude income transactions (type !== 'expense')
- Group by category and sum amounts
- Calculate percentages of total expenses
- Assign distinct colors for each category

### Component Specifications
**New Components Required**:
1. **ExpenseCategoryPieChart** (`src/components/dashboard/ExpenseCategoryPieChart.tsx`):
   - Props: `{ data: CategoryExpense[], loading: boolean, error?: string }`
   - Uses Recharts PieChart with responsive container
   - Custom tooltip showing category, amount, and percentage
   - Modern color palette with good contrast
   - Loading states using shadcn skeleton components

2. **ChartContainer** (`src/components/ui/chart-container.tsx`):
   - Reusable wrapper for chart components
   - Uses shadcn Card components for consistent styling
   - Responsive design for mobile/desktop
   - Error boundary for chart failures

**Existing Component Updates**:
- **DashboardBalances** (`src/components/dashboard/DashboardBalances.tsx`):
  - Add ExpenseCategoryPieChart integration
  - Handle new expensesByCategory data from dashboard API
  - Maintain existing layout and functionality

### File Locations
**Component Structure** [Source: architecture/source-tree.md#components]:
```
src/components/dashboard/
├── AccountBalanceCard.tsx              # Existing (from 4.1)
├── TotalNetWorthCard.tsx               # Existing (from 4.1)  
├── RecentTransactionItem.tsx           # Existing (from 4.2)
├── RecentTransactionsFeed.tsx          # Existing (from 4.2)
├── DashboardBalances.tsx               # Existing (needs extension)
├── ExpenseCategoryPieChart.tsx         # New - Modern Recharts pie chart
└── index.ts                            # Barrel exports (update)

src/components/ui/
├── card.tsx                            # Existing (shadcn)
├── badge.tsx                           # Existing (shadcn)  
├── button.tsx                          # Existing (shadcn)
├── skeleton.tsx                        # Existing (shadcn)
└── chart-container.tsx                 # New - Reusable chart wrapper
```

**API & Service Extensions** [Source: architecture/source-tree.md#app]:
```
src/app/api/dashboard/
└── stats/
    └── route.ts                        # Extend with category breakdown

src/lib/
├── dashboard.ts                        # Extend with category calculation functions
└── chart-utils.ts                     # New - Chart color palettes and utilities
```

### Modern Tech Stack Integration
**Required Dependencies**:
- **recharts** - React charting library with modern, accessible components
- **date-fns** - Modern date manipulation for month filtering
- **clsx/tailwind-merge** - Already available via shadcn for dynamic styling

**No Custom Building**:
- Leverage Recharts PieChart instead of building SVG from scratch
- Use shadcn Card components instead of custom containers
- Utilize existing Tailwind utilities for spacing and colors
- Follow established patterns from Stories 4.1 and 4.2

### Testing Requirements
**Testing Strategy** [Source: architecture/coding-standards.md#Testing Standards]:
- **Unit Tests**: Category aggregation logic, date filtering, percentage calculations
- **Component Tests**: Chart rendering, tooltip interactions, responsive behavior
- **Integration Tests**: Dashboard API with category breakdown data
- **Visual Tests**: Chart appearance and color accessibility

**Test Files**:
- `src/__tests__/components/dashboard/ExpenseCategoryPieChart.test.tsx`
- `src/__tests__/lib/chart-utils.test.ts`
- `src/__tests__/integration/dashboard-category-chart.test.ts`

### Technical Constraints
**Technology Stack** [Source: architecture/tech-stack.md]:
- **Frontend**: Next.js 15.5.3 with App Router, React 19.1.0, TypeScript 5.x
- **Styling**: Tailwind CSS 4.x with shadcn/ui design system
- **Charts**: Recharts 2.x for modern, accessible chart components
- **Database**: PostgreSQL via Supabase for transaction data

**Performance Considerations**:
- Client-side category aggregation for real-time updates
- Responsive chart sizing for mobile devices  
- Efficient data filtering for current month only
- Proper loading states during data fetch

**Accessibility Requirements**:
- ARIA labels for chart elements
- Keyboard navigation support
- Color-blind friendly palette
- Screen reader compatible tooltips

## Tasks / Subtasks

### Task 1: Install and Configure Recharts (AC: 1)
**Subtasks:**
1.1. Install recharts dependency (`npm install recharts`)
1.2. Verify compatibility with Next.js 15.5.3 and React 19.1.0
1.3. Create chart-utils.ts with color palette and formatting functions
1.4. Set up TypeScript types for chart data interfaces
1.5. Unit test chart utility functions

### Task 2: Extend Dashboard API with Category Data (AC: 1, 3)
**Subtasks:**
2.1. Extend dashboard service with getCategoryBreakdown function
2.2. Add current month filtering logic using date-fns
2.3. Implement category aggregation and percentage calculations
2.4. Update DashboardStats interface to include expensesByCategory
2.5. Add integration tests for category data endpoint

### Task 3: Create Modern Pie Chart Component (AC: 1, 2, 3)
**Subtasks:**
3.1. Create ExpenseCategoryPieChart.tsx using Recharts PieChart
3.2. Implement responsive container with shadcn Card wrapper
3.3. Add custom tooltip with category, amount, and percentage display
3.4. Configure modern color palette with accessibility considerations
3.5. Add loading states using shadcn skeleton components

### Task 4: Integrate Chart into Dashboard (AC: 1)
**Subtasks:**
4.1. Update DashboardBalances component to include chart
4.2. Handle expensesByCategory data from dashboard API
4.3. Add proper error handling and empty state display
4.4. Ensure responsive layout with existing dashboard components
4.5. Test chart integration with real transaction data

### Task 5: Component Testing and Validation (AC: 1, 2, 3)
**Subtasks:**
5.1. Write unit tests for ExpenseCategoryPieChart component
5.2. Test chart interactions (hover, tooltip display)
5.3. Validate responsive behavior on different screen sizes
5.4. Test accessibility features (keyboard navigation, screen readers)
5.5. Run integration tests with dashboard API

### Task 6: Final Integration and Polish (AC: 1, 2, 3)
**Subtasks:**
6.1. Update dashboard barrel exports to include new components
6.2. Add comprehensive component documentation
6.3. Perform visual regression testing
6.4. Validate color contrast and accessibility compliance
6.5. Test performance with large datasets

## Risks and Mitigations
- **Risk**: Recharts compatibility issues with Next.js 15.5.3
  - **Mitigation**: Use latest stable Recharts version, test integration early
- **Risk**: Chart performance with large transaction datasets
  - **Mitigation**: Implement client-side filtering and pagination if needed
- **Risk**: Color palette accessibility issues
  - **Mitigation**: Use WCAG-compliant color schemes, test with accessibility tools
- **Risk**: Mobile responsiveness challenges
  - **Mitigation**: Use ResponsiveContainer, test on multiple device sizes

*Created: 2025-09-26*  
*Story ID: STORY-4.3*  
*Status: Draft*  
*Assigned to: [Dev Agent]*
