# Story 1.5: Basic Billing and Subscription Setup

## Status
Deferred - Egypt Payment Limitations

**Note**: Stripe integration deferred due to limited payment provider availability in Egypt. Will be implemented later with Egypt-compatible payment solution (e.g., Paymob, Fawry, or other regional providers).

## Story
**As a** developer,
**I want** to integrate Stripe and set up the basic subscription plans,
**so that** new users are assigned a default plan upon signup and the foundation for SaaS billing is established.

## Acceptance Criteria
1. The Stripe SDK is integrated into the backend
2. "Free" and "Pro" tier plans are created in the Stripe dashboard
3. When a new user signs up, a corresponding customer is created in Stripe
4. A new entry is created in the `subscriptions` table for the user, defaulting to the "Free" plan

## Tasks / Subtasks
- [ ] Task 1: Install and Configure Stripe SDK (AC: 1)
  - [ ] Install Stripe Node.js SDK package
  - [ ] Configure Stripe environment variables (secret key, publishable key)
  - [ ] Create Stripe client configuration utility
  - [ ] Set up Stripe webhook endpoint for future use

- [ ] Task 2: Create Subscription Plans in Stripe Dashboard (AC: 2)
  - [ ] Create "Free" tier plan in Stripe dashboard (price: $0)
  - [ ] Create "Pro" tier plan in Stripe dashboard (price: TBD)
  - [ ] Document plan IDs for use in application
  - [ ] Configure plan metadata and features

- [ ] Task 3: Integrate Stripe Customer Creation with User Signup (AC: 3, 4)
  - [ ] Update user signup API to create Stripe customer
  - [ ] Create subscription record in database with Free plan default
  - [ ] Handle Stripe customer creation errors gracefully
  - [ ] Ensure atomic operation (user + Stripe customer + subscription)

- [ ] Task 4: Create Subscription Management API Endpoints (AC: 4)
  - [ ] Create GET /api/subscription endpoint to retrieve user subscription
  - [ ] Create POST /api/subscription/upgrade endpoint for future use
  - [ ] Implement subscription status validation middleware
  - [ ] Add subscription data to user session/context

- [ ] Task 5: Testing and Validation (All ACs)
  - [ ] Test Stripe integration with test API keys
  - [ ] Verify customer creation during signup flow
  - [ ] Test subscription record creation in database
  - [ ] Validate error handling for Stripe API failures

## Dev Notes

### Previous Story Insights
Stories 2.1-2.3 completed the BetterAuth migration:
- Enhanced authentication system with BetterAuth 1.3.13 [Source: 2.3 completion notes]
- Dual authentication support (BetterAuth + legacy JWT) [Source: 2.2 implementation]
- Frontend authentication integration completed [Source: 2.3 QA results]
- User signup flow established and working [Source: 1.3 implementation]

### Data Models
Database schema for subscriptions: [Source: architecture/3-database-schema.md]
```sql
subscriptions table:
- id (UUID, PK)
- user_id (FK → users.id)
- plan (free/pro)
- status (active/canceled)
- renewal_date
- created_at
```

User table structure: [Source: architecture/3-database-schema.md]
```sql
users table:
- id (UUID, PK)
- email
- password_hash
- created_at
```

### API Specifications
New endpoints to be created:
- `POST /api/stripe/webhook` → Stripe webhook handler for subscription events
- `GET /api/subscription` → Get current user subscription details
- `POST /api/subscription/upgrade` → Upgrade user subscription (future use)

Integration with existing signup endpoint:
- `POST /api/auth/signup` → Enhanced to create Stripe customer and subscription

### Component Specifications
No frontend components required for this story - backend integration only.
Future subscription management UI will be built in later stories.

### File Locations
Based on Next.js 15.5.3 App Router structure: [Source: architecture/source-tree.md]
- Stripe configuration: `/src/lib/stripe.ts` (new)
- Subscription utilities: `/src/lib/subscription.ts` (new)
- API routes: `/src/app/api/stripe/` (new directory)
- API routes: `/src/app/api/subscription/` (new directory)
- Types: `/src/types/subscription.ts` (new)

### Technical Constraints
- Next.js 15.5.3 with App Router compatibility required [Source: architecture/tech-stack.md]
- Supabase PostgreSQL database integration [Source: architecture/tech-stack.md]
- TypeScript strict mode compliance [Source: architecture/coding-standards.md]
- Environment variable management with dotenv [Source: architecture/tech-stack.md]
- Integration with existing BetterAuth authentication system

### Testing Standards
Testing requirements for subscription integration: [Source: architecture/coding-standards.md]
- Test file location: `src/__tests__/api/subscription/` directory
- Use Jest for API endpoint testing [Source: architecture/tech-stack.md]
- Mock Stripe SDK for unit tests
- Integration tests for signup flow with Stripe
- Error handling tests for Stripe API failures

Specific testing requirements for this story:
- Stripe customer creation tests
- Subscription record creation tests
- API endpoint functionality tests
- Error handling and rollback tests
- Webhook endpoint validation tests

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-23 | 1.0 | Initial story creation for basic billing and subscription setup | BMad Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent after implementation)
